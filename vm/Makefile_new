# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Makefile                                           :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: mda-cost <mda-cost@student.42.fr>          +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2017/11/02 11:30:14 by mda-cost          #+#    #+#              #
#    Updated: 2017/11/02 14:52:41 by mda-cost         ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

NAME	= vm
FLAGS	= -g -Wextra -Wall -Werror -D_XOPEN_SOURCE_EXTENDED
SHELL	= /bin/bash
CC		= gcc
SOUND	= sound
LIB		= libft
INCS	= incs
SRCS	= srcs
OBJS	= objs

INCLUDES	= -I$(INCS) -I$(LIB)/$(INCS) -I$(SOUND)
LIBS		= -L $(LIB) -lft -lncurses ~/.brew/lib/libsndfile.1.dylib
LINK		= -L sound/ -lcommon  -L sound/ -lportaudio -Lsound/ -lsndfile
FRAMEWORK	= -framework CoreServices -framework CoreFoundation \
			-framework AudioUnit -framework AudioToolbox -framework CoreAudio

# Search headers files
I_FILES = $(shell find $(INCS) -type f)

# Search source files
C_FILES	= $(shell find $(SRCS) -type f)

# All .c folder's names.
C_DIRS	= $(shell find $(SRCS) -depth -type d)

# All objects folders.
O_DIRS 	= $(addprefix $(OBJS)/,$(C_DIRS))

# All objects files.
O_FILES	= $(C_FILES:%.c=$(OBJS)/%.o)

# Create OBJS folder structure
$(shell mkdir -p $(O_DIRS))

ACTUAL		= $(words $(COUNT))
TOTAL		= $(words $(filter %.c,$(C_FILES)))

PRINTINC	= $(eval COUNT+=1) $(PRINT)
PRINT		= echo "compiling --> $(ACTUAL) / $(TOTAL)"
PRINTDONE	= echo "compiling --> $@"

all: $(NAME)

$(NAME): $(O_FILES)
	@make -C $(LIB)
	@$(CC) $(FLAGS) $(LIBS) $(LINK) $(FRAMEWORK) $^ -o $@ && $(PRINTDONE)

$(OBJS)/%.o: %.c $(I_FILES)
	@$(CC) $(FLAGS) $(INCLUDES) -c $< -o $@ && $(PRINTINC)

clean:
	@/bin/rm -f $(SRCO)
	@make clean -C $(LIB)

fclean: clean
	@/bin/rm -f $(NAME)
	@make fclean -C $(LIB)

re: fclean all

.PHONY: clean fclean re all make_lib
